<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸ­ãŠã‚„ã¤å ã„ Ultimate</title>
<style>
body{margin:0;font-family:sans-serif;background:#ffeaf4;text-align:center}
.wrap{max-width:600px;margin:auto;padding:12px}
.card{background:#fff;padding:18px;border-radius:18px;box-shadow:0 8px 25px rgba(0,0,0,.12);margin-bottom:16px}
input,select,button{padding:10px;border-radius:10px;border:1px solid #ddd;margin:6px;width:100%}
.row{display:flex;gap:8px}
.row input,.row select{flex:1}
canvas{width:100%;background:#fff;border-radius:14px;margin-top:12px;touch-action:none}
.tools{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.tools button{width:auto;padding:8px 14px}
.small{font-size:12px;color:#777}
</style>
</head>
<body>
<div class="wrap">

<!-- åˆæœŸå…¥åŠ›ç”»é¢ -->
<div class="card" id="startScreen">
<h2>ğŸ­ ãŠã‚„ã¤å ã„</h2>

<input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
<input type="date" id="birthday" value="">
<select id="gender">
<option value="">æ€§åˆ¥</option>
<option>ç”·</option>
<option>å¥³</option>
<option>ãã®ä»–</option>
<option>å›ç­”ã—ãªã„</option>
</select>
<div class="row">
<input type="number" id="height" placeholder="èº«é•·(cm)" value="">
<input type="number" id="weight" placeholder="ä½“é‡(kg)" value="">
</div>
<input type="number" id="sleep" placeholder="å¹³å‡ç¡çœ æ™‚é–“(æ™‚é–“)" value="">
<select id="type">
<option value="">å±æ€§</option>
<option>é‹å‹•éƒ¨</option>
<option>æ–‡åŒ–éƒ¨</option>
<option>å¸°å®…éƒ¨</option>
<option>ç¤¾ä¼šäºº</option>
</select>

<button onclick="startFortune()">å ã†</button>
<div id="count"></div>
<div class="small">å ã„ã§å‡ºãŸã‚‚ã®ã‚’æã„ã¦ã¿ã¦ã‚‚ã„ã„ã‹ã‚‚ï¼Ÿ</div>
</div>

<!-- å ã„çµæœç”»é¢ -->
<div class="card" id="resultScreen" style="display:none">
<h2>ğŸ”® ä»Šæ—¥ã®çµæœ</h2>
<div id="resultText"></div>

<h3>ğŸ¨ èƒŒæ™¯</h3>
<input type="color" id="bgColor" value="#ffffff">
<input type="file" id="bgUpload" accept="image/*">

<canvas id="canvas" width="1080" height="1920"></canvas>

<h3>âœ¨ ãƒ‡ã‚³</h3>
<div class="row">
<input id="textInput" placeholder="æ–‡å­—è¿½åŠ ">
<input type="color" id="textColor" value="#000000">
<input type="number" id="textSize" value="80">
</div>

<div class="tools">
<button onclick="addText()">æ–‡å­—</button>
<button onclick="addStamp()">ã‚¹ã‚¿ãƒ³ãƒ—</button>
<button onclick="addImage()">ç”»åƒ</button>
<button onclick="bringFront()">å‰ã¸</button>
<button onclick="sendBack()">å¾Œã‚ã¸</button>
<button onclick="deleteObj()">å‰Šé™¤</button>
<button onclick="undo()">æˆ»ã‚‹</button>
<button onclick="redo()">é€²ã‚€</button>
</div>

<h3>ğŸ“¤ å…±æœ‰</h3>
<div class="tools">
<button onclick="saveImage()">ç”»åƒä¿å­˜</button>
<button onclick="shareNative()">å…±æœ‰</button>
<button onclick="shareX()">X</button>
<button onclick="shareLINE()">LINE</button>
<button onclick="shareFB()">Facebook</button>
</div>
</div>

</div>

<script>
// ===== ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šçŸ­ç¸®ç‰ˆ / å®Ÿéš›ã¯100å€‹å…¥ã‚Œã¦OKï¼‰=====
const snacks=["ãƒãƒƒã‚­ãƒ¼","ã‚­ãƒƒãƒˆã‚«ãƒƒãƒˆ","ãƒ–ãƒ©ãƒƒã‚¯ã‚µãƒ³ãƒ€ãƒ¼","ã˜ã‚ƒãŒã‚Šã“","å …ã‚ã’ãƒãƒ†ãƒˆ","ã‚¢ãƒ«ãƒ•ã‚©ãƒ¼ãƒˆ","ãƒ«ãƒãƒ³ãƒ‰","ã‚ªãƒ¬ã‚ª","ãƒ‘ã‚¤ã®å®Ÿ","ã‚¬ãƒ¼ãƒŠ"];
const drinks=["ã‚³ã‚«ãƒ»ã‚³ãƒ¼ãƒ©","ä¸‰ãƒ„çŸ¢ã‚µã‚¤ãƒ€ãƒ¼","ã‚«ãƒ«ãƒ”ã‚¹","åˆå¾Œã®ç´…èŒ¶","ãƒã‚«ãƒª","ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼","CCãƒ¬ãƒ¢ãƒ³","å¤©ç„¶æ°´","ãƒ¤ã‚¯ãƒ«ãƒˆ","åå…­èŒ¶"];
const messages=["ä»Šæ—¥ã¯ãƒ©ãƒƒã‚­ãƒ¼","ç¬‘é¡”ãŒé‹æ°—UP","ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥","ç„¡ç†ã—ãªãã¦OK","æœªæ¥æ˜ã‚‹ã„","å‹è² é‹ã‚ã‚Š","è‰¯ç¸ã‚ã‚Š","ç›´æ„Ÿã‚’ä¿¡ã˜ã¦","æŒ‘æˆ¦æˆåŠŸç‡é«˜ã‚","æœ€é«˜ã®ä¸€æ—¥"];

const today=new Date().toISOString().slice(0,10);

// ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ä¿å­˜/èª­ã¿è¾¼ã¿ =====
function loadUserData() {
  const savedData = JSON.parse(localStorage.getItem("userData"));
  if (savedData) {
    document.getElementById("nickname").value = savedData.nickname || "";
    document.getElementById("birthday").value = savedData.birthday || "";
    document.getElementById("gender").value = savedData.gender || "";
    document.getElementById("height").value = savedData.height || "";
    document.getElementById("weight").value = savedData.weight || "";
    document.getElementById("sleep").value = savedData.sleep || "";
    document.getElementById("type").value = savedData.type || "";
  }
}
loadUserData();

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ä¿å­˜
function saveUserData() {
  const userData = {
    nickname: document.getElementById("nickname").value,
    birthday: document.getElementById("birthday").value,
    gender: document.getElementById("gender").value,
    height: document.getElementById("height").value,
    weight: document.getElementById("weight").value,
    sleep: document.getElementById("sleep").value,
    type: document.getElementById("type").value
  };
  localStorage.setItem("userData", JSON.stringify(userData));
}

// ===== å ã„ =====
function startFortune() {
  saveUserData();  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜

  if (localStorage.getItem("fortuneDate") === today) {
    alert("ä»Šæ—¥ã¯ã‚‚ã†å ã„ã¾ã—ãŸï¼");
    return;
  }

  if (!birthday.value || !gender.value || !height.value || !weight.value || !sleep.value || !type.value || !nickname.value) {
    alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  let sec = 5;
  count.textContent = "å ã„ä¸­â€¦ " + sec;
  const timer = setInterval(() => {
    sec--;
    count.textContent = "å ã„ä¸­â€¦ " + sec;
    if (sec <= 0) {
      clearInterval(timer);
      localStorage.setItem("fortuneDate", today);
      showResult();
    }
  }, 1000);
}

function showResult() {
  startScreen.style.display = "none";
  resultScreen.style.display = "block";

  // æ¯æ—¥ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆãã®æ—¥ã ã‘å›ºå®šï¼‰
  const snack = snacks[Math.floor(Math.random() * snacks.length)];
  const drink = drinks[Math.floor(Math.random() * drinks.length)];
  const msg = messages[Math.floor(Math.random() * messages.length)];

  window.shareText = `ä»Šæ—¥ã®ãŠã‚„ã¤å ã„ğŸ­
ğŸª ${snack}
ğŸ¥¤ ${drink}
ğŸ’¬ ${msg}`;

  resultText.innerHTML =
    `ğŸª ${snack}<br>
ğŸ¥¤ ${drink}<br>
ğŸ’¬ ${msg}`;

  initCanvas();
}

// ===== Canvasã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆãƒ—ãƒ­ä»•æ§˜ï¼‰ =====
let canvas, ctx, objects = [], selected = null, history = [], redoStack = [];

function initCanvas() {
  canvas = document.getElementById("canvas");
  ctx = canvas.getContext("2d");

  bgColor.oninput = () => canvas.style.background = bgColor.value;

  bgUpload.onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  canvas.onpointerdown = e => {
    selected = objects.find(o => Math.abs(o.x - e.offsetX) < 150 && Math.abs(o.y - e.offsetY) < 150);
  };

  canvas.onpointermove = e => {
    if (selected) {
      selected.x = e.offsetX;
      selected.y = e.offsetY;
      draw();
    }
  };

  canvas.onpointerup = () => selected = null;

  window.addEventListener("wheel", e => {
    if (selected) {
      selected.scale += e.deltaY * -0.001;
      selected.scale = Math.max(0.1, Math.min(3, selected.scale));
      draw();
    }
  });

  window.addEventListener("resize", () => draw());
}

// æç”»
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // èƒŒæ™¯ã‚’æç”»
  objects.forEach(o => {
    ctx.save();
    ctx.translate(o.x, o.y);
    ctx.scale(o.scale, o.scale);

    if (o.type === "text") {
      ctx.font = `${o.size}px sans-serif`;
      ctx.fillStyle = o.color;
      ctx.fillText(o.text, 0, 0);
    } else if (o.type === "stamp") {
      ctx.fillStyle = "#FF4500";
      ctx.fillText(o.text, 0, 0);
    }

    ctx.restore();
  });
}

// æ–‡å­—è¿½åŠ 
function addText() {
  const text = textInput.value || "ãƒ†ã‚­ã‚¹ãƒˆ";
  const size = textSize.value || 40;
  const color = textColor.value || "#000";
  objects.push({ type: "text", x: 100, y: 100, text, size, color, scale: 1 });
  draw();
}

// ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
function addStamp() {
  const stamp = "ğŸ¬";
  objects.push({ type: "stamp", x: 100, y: 100, text: stamp, size: 50, color: "#000", scale: 1 });
  draw();
}

// ç”»åƒè¿½åŠ 
function addImage() {
  const img = new Image();
  img.src = "https://placekitten.com/150/150"; // ç”»åƒURLï¼ˆä»»æ„ï¼‰
  img.onload = () => {
    objects.push({ type: "image", x: 100, y: 100, img, scale: 1 });
    draw();
  };
}

function saveImage() {
  const a = document.createElement("a");
  a.href = canvas.toDataURL();
  a.download = "image.png";
  a.click();
}

// SNSã‚·ã‚§ã‚¢
function shareNative() {
  navigator.clipboard.writeText(shareText);
  alert("å…±æœ‰ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

function shareX() {
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`);
}

function shareLINE() {
  window.open(`https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`);
}

function shareFB() {
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`);
}

// æˆ»ã‚‹
function undo() {
  if (history.length > 0) {
    const lastAction = history.pop();
    redoStack.push(lastAction);
    objects = [...history];
    draw();
  }
}

// é€²ã‚€
function redo() {
  if (redoStack.length > 0) {
    const lastAction = redoStack.pop();
    history.push(lastAction);
    objects = [...history];
    draw();
  }
}

// ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰é¢ã«ç§»å‹•
function bringFront() {
  if (selected) {
    objects = [...objects.filter(o => o !== selected), selected];
    draw();
  }
}

// ã‚¢ã‚¤ãƒ†ãƒ ã‚’èƒŒé¢ã«ç§»å‹•
function sendBack() {
  if (selected) {
    objects = [selected, ...objects.filter(o => o !== selected)];
    draw();
  }
}

// ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
function deleteObj() {
  if (selected) {
    objects = objects.filter(o => o !== selected);
    draw();
  }
}
</script>
</body>
</html>
